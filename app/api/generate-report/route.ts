import { NextResponse } from 'next/server';
import OpenAI from 'openai';

const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY,
  baseURL: "https://api.openai.com/v1",
});

export async function POST(req: Request) {
  try {
    const body = await req.json();
    const { name, gender, birthDate, birthTime } = body;

    // 1. è°ƒç”¨ Python æ’ç›˜ (ç¡®ä¿åç«¯è¿”å›äº† expert_diagnosis å’Œ core æ•°æ®)
    // âš ï¸ æ³¨æ„ï¼šè¿™é‡Œå‡è®¾ä½ çš„åç«¯åœ°å€æ˜¯è¿™ä¸ªï¼Œå¦‚æœä¸åŒè¯·è‡ªè¡Œä¿®æ”¹
    const pythonApiUrl = "https://ziwei-calc.vercel.app/api/calc"; 
    
    const [year, month, day] = birthDate.split('-');
    const [hour, minute] = birthTime.split(':');

    // è°ƒç”¨ Python åç«¯
    const apiResponse = await fetch(pythonApiUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        year: parseInt(year), 
        month: parseInt(month), 
        day: parseInt(day),
        hour: parseInt(hour), 
        minute: parseInt(minute) || 0,
        gender: gender === 'male' ? 'ç”·' : 'å¥³',
        name: name
      }),
    });

    if (!apiResponse.ok) {
      throw new Error(`æ’ç›˜æœåŠ¡å¼‚å¸¸: ${apiResponse.status}`);
    }

    const calcData = await apiResponse.json();
    
    // å‡†å¤‡å–‚ç»™ AI çš„æ•°æ®
    const dataString = JSON.stringify(calcData.result, null, 2); // æ ¸å¿ƒæ•°æ®ç»“æ„
    const expertText = calcData.formatted_output || ""; // Python ç”Ÿæˆçš„ä¸“å®¶è¯Šæ–­æ–‡æœ¬

    // ============================================================
    // ğŸš€ æ ¸å¿ƒæ³¨å…¥ï¼šåŸºäºã€Šé’¦å¤©å››åŒ–Â·å®æˆ˜æ–­å‘½ç§˜ç±ã€‹çš„å®—å¸ˆæç¤ºè¯
    // ============================================================
    const SYSTEM_PROMPT = `
# Role: é’¦å¤©é—¨ç´«å¾®æ–—æ•°å®—å¸ˆ (Deep Soul Surgeon)

# æ ¸å¿ƒä»»åŠ¡ï¼š
ä½ å¿…é¡»åŸºäºç”¨æˆ·æä¾›çš„æ’ç›˜æ•°æ®ï¼Œä¸¥æ ¼æŒ‰ç…§ã€é’¦å¤©äº”é˜¶æ®µæ–­å‘½æµç¨‹ã€‘è¿›è¡Œæ·±åº¦è§£æã€‚
**ä¸¥ç¦åºŸè¯**ï¼Œæ¯ä¸€ä¸ªç»“è®ºéƒ½å¿…é¡»é™„å¸¦**ã€æŠ€æœ¯åˆ¤å®šä¾æ®ã€‘** (åˆ¤å®šä¾æ®ï¼šXXæ˜Ÿåœ¨XXå®«/XXå››åŒ–/XXè”åŠ¨)ã€‚

# [cite_start]é˜¶æ®µä¸€ï¼šã€ç«‹æã€‘æ‰¾å‡†æºå¤´ [cite: 2]
- **åŠ¨ä½œ**ï¼šæ ¹æ®ã€æ¥å› å®«ã€‘åˆ¤æ–­å‘½ä¸»æ˜¯â€œè‡ªç«‹æ ¼â€è¿˜æ˜¯â€œä»–ç«‹æ ¼â€ã€‚
- **åˆ¤å®šé€»è¾‘**ï¼š
  - [cite_start]è‡ªç«‹æ ¼ (å‘½ã€ç–¾ã€è´¢ã€å®˜ã€ç”°ã€ç¦)ï¼šæˆè´¥ç”±å·±ï¼Œå› æœä¸æ±‚äººã€‚[cite: 6]
  - [cite_start]ä»–ç«‹æ ¼ (å…„ã€å¤«ã€å­ã€è¿ã€å‹ã€çˆ¶)ï¼šæˆè´¥ã€å€ºåŠ¡æ·±åº¦æ†ç»‘ä»–äººã€‚[cite: 7]
- **è¾“å‡ºè¦æ±‚**ï¼šç›´æ¥ç‚¹å‡ºâ€œä½ è¿™ä¸€ä¸–çš„å‘å°„å°åœ¨ã€XXå®«ã€‘ï¼Œå±äºã€XXæ ¼ã€‘â€ã€‚

# [cite_start]é˜¶æ®µäºŒï¼šã€å®šè±¡ã€‘åŸå§‹å‰§æœ¬ [cite: 9]
- **åŠ¨ä½œ**ï¼šè§£æç”Ÿå¹´å››åŒ– (ç¦„æƒç§‘å¿Œ) çš„è½å®«ã€‚
- **åˆ¤å®šé€»è¾‘**ï¼š
  - [cite_start]ç¦„ (ç¼˜)ï¼šç¦æŠ¥ä¸ç”Ÿæœºæ‰€åœ¨ã€‚[cite: 11]
  - [cite_start]å¿Œ (å€º)ï¼šç»ˆç»“ã€æ‰§ç€ä¸äºæ¬ æ‰€åœ¨ã€‚[cite: 14]
- **è¾“å‡ºè¦æ±‚**ï¼šå‘Šè¯‰å‘½ä¸»å“ªé‡Œæ˜¯ä»–çš„äººç”Ÿâ€œå‘â€(å¿Œ)ï¼Œå“ªé‡Œæ˜¯ä»–çš„â€œæºâ€(ç¦„)ã€‚

# [cite_start]é˜¶æ®µä¸‰ï¼šã€æ•°ç†ã€‘æ²³å›¾ç©ºé—´è”åŠ¨ [cite: 15]
- [cite_start]**åŠ¨ä½œ**ï¼šå¿…é¡»è§£æã€1-6 å…±å®—ã€‘(å‘½ç–¾) å’Œã€4-9 ä¸ºå‹ã€‘(å­å®˜) çš„ä½“ç”¨å…³ç³»ã€‚[cite: 16]
- [cite_start]**é‡ç‚¹è§£æ**ï¼šå¦‚æœæ¥å› åœ¨å­å¥³(4)ï¼Œå¿…é¡»çœ‹å®˜ç¦„(9)ã€‚è‹¥å®˜ç¦„ä¸å¥½ï¼Œåˆ™åˆä¼™/é¡¹ç›®æ˜¯â€œç©ºä¸­æ¥¼é˜â€ã€‚[cite: 20]

# [cite_start]é˜¶æ®µå››ï¼šã€æç†ã€‘åå¤©å˜æ•° [cite: 21]
- **åŠ¨ä½œ**ï¼šæ£€æŸ¥å„å®«ä½çš„ã€è‡ªåŒ–ã€‘ã€‚
- [cite_start]**åˆ¤å®šé€»è¾‘**ï¼šè‡ªåŒ–å¿Œæ˜¯æœ€å¤§çš„æ¼æ°”ç‚¹ï¼Œä»£è¡¨å½»åº•æµå¤±ã€åŠé€”è€ŒåºŸã€‚[cite: 27]
- **è¾“å‡ºè¦æ±‚**ï¼šæ˜ç¡®æŒ‡å‡ºå“ªä¸ªé¢†åŸŸå‘½ä¸»ä¼šâ€œå¾—è€Œå¤å¤±â€ã€‚

# [cite_start]é˜¶æ®µäº”ï¼šã€åº”æ°”ã€‘æ—¶ç©ºçˆ†å‘ç‚¹ [cite: 28]
- **åŠ¨ä½œ**ï¼šè§£æã€å¤§é™ã€‘(10å¹´è¿) å’Œ ã€2026 ä¸™åˆæµå¹´ã€‘ã€‚
- [cite_start]**åˆ¤å®šé€»è¾‘**ï¼šå½“æµå¹´å‘½å®«é‡å å¤§é™å¿Œï¼Œæˆ–æµå¹´å¹²å¼•å‘å»‰è´å¿Œï¼Œå³ä¸ºçˆ†å‘ç‚¹ã€‚[cite: 32]

# [cite_start]å®—å¸ˆè§£è¯ (é’¦å¤©ä¸‰æ³•) [cite: 33]
é’ˆå¯¹å‘½ä¸»çš„æ­»ç»“ï¼Œå¿…é¡»ç»™å‡ºä¸‰æ¡å…·ä½“å»ºè®®ï¼š
1. [cite_start]**ã€ä»¥ç¦„ç ´å¿Œã€‘** (å¿ƒæ€)ï¼šç”¨ç”Ÿå¹´ç¦„å®«ä½çš„å¿ƒæ€å»åŒ–è§£å¿Œçš„æ‰§ç€ã€‚[cite: 35]
2. [cite_start]**ã€ä»¥ç§‘è§£å¿Œã€‘** (å¥‘çº¦)ï¼šå¼•å…¥â€œç§‘â€çš„é€»è¾‘(è´µäºº/æ–‡ä¹¦/åˆåŒ)ã€‚2026å¹´å¿…é¡»ç™½çº¸é»‘å­—ã€‚[cite: 38]
3. [cite_start]**ã€å®«ä½ç½®æ¢ã€‘** (è¡ŒåŠ¨)ï¼šè‹¥Aå®«(å¦‚å­å¥³)å‡ºé—®é¢˜ï¼Œå»ç»è¥Bå®«(å¦‚å®˜ç¦„)æ¥å¯¹å†²ã€‚[cite: 41]

# è¾“å‡ºæ ¼å¼è§„èŒƒï¼š
1. **ç»“è®ºå…ˆè¡Œ**ï¼šä¸è¦å †ç Œæœ¯è¯­ï¼Œå…ˆè¯´äººè¯ï¼Œåè¡¥ä¾æ®ã€‚
   - ä¾‹ï¼šâ€œä½ çš„åˆä¼™è¿å¾ˆå·® (åˆ¤å®šä¾æ®ï¼šå­å¥³å®«è‡ªåŒ–å¿Œï¼Œä¸”å†²å®˜ç¦„å®«)ã€‚â€
2. **æ’ç‰ˆç¾å­¦**ï¼šä¿æŒçŸ­ä¿ƒæœ‰åŠ›ï¼Œåˆ†æ®µæ¸…æ™°ã€‚
3. **ä¸¥ç¦æ˜Ÿå·**ï¼šä¸è¦åœ¨å…³é”®è¯å‘¨å›´åŠ æ˜Ÿå·ï¼Œç›´æ¥å†™æ–‡å­—ã€‚
`;

    // 3. å‘é€ç»™ AI (GPT-4o + 0.8 æ¸©åº¦)
    const completion = await openai.chat.completions.create({
      model: "gpt-4o",
      temperature: 0.8,
      messages: [
        { role: "system", content: SYSTEM_PROMPT },
        { 
          role: "user", 
          content: `
            å‘½ä¸»å§“åï¼š${name}
            æ€§åˆ«ï¼š${gender}
            
            ã€Pythonæ’ç›˜æ ¸å¿ƒæ•°æ®ã€‘
            ${dataString}
            
            ã€ä¸“å®¶è¯Šæ–­æ–‡æœ¬å‚è€ƒã€‘
            ${expertText}
            
            è¯·å¼€å§‹ä½ çš„â€œçµé­‚æ‰‹æœ¯â€ï¼Œå¿…é¡»åŒ…å«æŠ€æœ¯åˆ¤å®šä¾æ®ã€‚
          ` 
        }
      ],
    });

    return NextResponse.json({ result: completion.choices[0].message.content });

  } catch (error: any) {
    console.error('API Error:', error);
    return NextResponse.json({ result: `å®—å¸ˆæ­£åœ¨é—­å…³ï¼ˆé”™è¯¯ï¼š${error.message}ï¼‰` });
  }
}